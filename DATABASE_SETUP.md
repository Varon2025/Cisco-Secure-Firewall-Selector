# Guide de Configuration PostgreSQL pour Cisco Secure Firewall Selector

Ce guide vous explique comment connecter votre application √† une base de donn√©es PostgreSQL existante.

## üìã Table des mati√®res

1. [Pr√©requis](#pr√©requis)
2. [Installation de PostgreSQL](#installation-de-postgresql)
3. [Configuration de la base de donn√©es](#configuration-de-la-base-de-donn√©es)
4. [Installation des d√©pendances Node.js](#installation-des-d√©pendances-nodejs)
5. [Configuration de l'application](#configuration-de-lapplication)
6. [Initialisation de la base de donn√©es](#initialisation-de-la-base-de-donn√©es)
7. [D√©marrage du serveur](#d√©marrage-du-serveur)
8. [Utilisation de l'API](#utilisation-de-lapi)
9. [D√©ploiement sur GitHub/Heroku](#d√©ploiement)

---

## üîß Pr√©requis

- **Node.js** version 16 ou sup√©rieure
- **PostgreSQL** version 12 ou sup√©rieure
- **npm** ou **yarn**
- Un √©diteur de texte (VS Code, Sublime, etc.)

---

## üì¶ Installation de PostgreSQL

### Sur Ubuntu/Debian:
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### Sur macOS (avec Homebrew):
```bash
brew install postgresql@15
brew services start postgresql@15
```

### Sur Windows:
T√©l√©chargez et installez depuis: https://www.postgresql.org/download/windows/

---

## üóÑÔ∏è Configuration de la base de donn√©es

### 1. Acc√©der √† PostgreSQL

```bash
# Se connecter en tant qu'utilisateur postgres
sudo -u postgres psql
```

### 2. Cr√©er une base de donn√©es et un utilisateur

```sql
-- Cr√©er un utilisateur
CREATE USER cisco_user WITH PASSWORD 'votre_mot_de_passe_securise';

-- Cr√©er la base de donn√©es
CREATE DATABASE cisco_firewalls OWNER cisco_user;

-- Accorder tous les privil√®ges
GRANT ALL PRIVILEGES ON DATABASE cisco_firewalls TO cisco_user;

-- Quitter psql
\q
```

### 3. Tester la connexion

```bash
psql -h localhost -U cisco_user -d cisco_firewalls
```

Si vous pouvez vous connecter, votre base de donn√©es est pr√™te!

---

## üì• Installation des d√©pendances Node.js

Dans le r√©pertoire du projet:

```bash
# Installer les d√©pendances
npm install

# Ou avec yarn
yarn install
```

Cela installera:
- `express` - Framework web
- `pg` - Client PostgreSQL pour Node.js
- `dotenv` - Gestion des variables d'environnement
- `cors` - Gestion des requ√™tes cross-origin
- `nodemon` - Red√©marrage automatique en d√©veloppement (dev only)

---

## ‚öôÔ∏è Configuration de l'application

### 1. Cr√©er le fichier `.env`

Copiez le fichier `.env.example` en `.env`:

```bash
cp .env.example .env
```

### 2. √âditer le fichier `.env`

Ouvrez `.env` et configurez vos param√®tres:

```env
# Configuration PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_NAME=cisco_firewalls
DB_USER=cisco_user
DB_PASSWORD=votre_mot_de_passe_securise

# Configuration du serveur
PORT=3000
NODE_ENV=development

# CORS - Domaines autoris√©s
ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
```

**‚ö†Ô∏è IMPORTANT:** Ne commitez JAMAIS le fichier `.env` sur GitHub!

Ajoutez `.env` √† votre `.gitignore`:

```bash
echo ".env" >> .gitignore
```

---

## üöÄ Initialisation de la base de donn√©es

### 1. Cr√©er le sch√©ma et importer les donn√©es

```bash
npm run init-db
```

Ce script va:
1. ‚úÖ Cr√©er les tables dans PostgreSQL
2. ‚úÖ Charger les donn√©es depuis `data/firewalls.json`
3. ‚úÖ Ins√©rer les donn√©es dans la base
4. ‚úÖ Cr√©er les index pour optimiser les performances

### 2. V√©rifier l'importation

Connectez-vous √† PostgreSQL:

```bash
psql -h localhost -U cisco_user -d cisco_firewalls
```

Ex√©cutez quelques requ√™tes de test:

```sql
-- Compter le nombre de produits
SELECT COUNT(*) FROM products;

-- Voir les 5 premiers produits
SELECT model, family, form_factor, fw_gbps FROM products LIMIT 5;

-- Voir toutes les familles
SELECT DISTINCT family FROM products ORDER BY family;

-- Rechercher un mod√®le sp√©cifique
SELECT * FROM products WHERE model LIKE '%FPR1120%';
```

---

## üåê D√©marrage du serveur

### Mode d√©veloppement (avec red√©marrage automatique):

```bash
npm run dev
```

### Mode production:

```bash
npm start
```

Le serveur d√©marre sur `http://localhost:3000`

### V√©rifier que tout fonctionne:

Ouvrez votre navigateur et testez:

1. **Page d'accueil**: http://localhost:3000
2. **Health check**: http://localhost:3000/api/health
3. **Tous les produits**: http://localhost:3000/api/firewalls
4. **Produit sp√©cifique**: http://localhost:3000/api/firewalls/FPR1120

---

## üì° Utilisation de l'API

### Endpoints disponibles:

#### 1. Health Check
```
GET /api/health
```
V√©rifier l'√©tat du serveur et de la connexion √† la base de donn√©es.

**R√©ponse:**
```json
{
  "status": "OK",
  "database": "connected",
  "timestamp": "2025-01-15T10:30:00.000Z"
}
```

#### 2. R√©cup√©rer tous les produits
```
GET /api/firewalls
```

**Param√®tres de requ√™te (optionnels):**
- `search` - Rechercher dans mod√®le ou famille
- `family` - Filtrer par famille
- `form_factor` - Filtrer par format
- `fw_min` - D√©bit firewall minimum (Gbps)
- `threat_min` - D√©bit threat minimum (Gbps)
- `ips_min` - D√©bit IPS minimum (Gbps)

**Exemples:**
```bash
# Tous les produits
curl http://localhost:3000/api/firewalls

# Recherche par mod√®le
curl "http://localhost:3000/api/firewalls?search=FPR"

# Filtrer par famille et performances
curl "http://localhost:3000/api/firewalls?family=1100&fw_min=5"
```

**R√©ponse:**
```json
{
  "products": [
    {
      "model": "FPR1120",
      "family": "1100",
      "form_factor": "Desktop",
      "perf": {
        "fw_gbps": 4.5,
        "threat_gbps": 2.1,
        "ips_gbps": 1.8
      },
      "hardware": {
        "sku": "FPR1120-NGFW-K9",
        "gpl": 2500.00
      },
      ...
    }
  ],
  "meta": {
    "license_terms_supported": [1, 3, 5],
    "count": 42
  }
}
```

#### 3. R√©cup√©rer un produit sp√©cifique
```
GET /api/firewalls/:model
```

**Exemple:**
```bash
curl http://localhost:3000/api/firewalls/FPR1120
```

#### 4. R√©cup√©rer toutes les familles
```
GET /api/families
```

**R√©ponse:**
```json
{
  "families": ["1100", "2100", "4100", "9300"]
}
```

---

## üöÄ D√©ploiement

### Sur Heroku (avec PostgreSQL):

#### 1. Installer Heroku CLI
```bash
# Sur macOS
brew install heroku/brew/heroku

# Sur Ubuntu
curl https://cli-assets.heroku.com/install.sh | sh
```

#### 2. Cr√©er une application Heroku
```bash
heroku login
heroku create cisco-firewall-selector
```

#### 3. Ajouter PostgreSQL
```bash
heroku addons:create heroku-postgresql:essential-0
```

#### 4. Configurer les variables d'environnement
```bash
heroku config:set NODE_ENV=production
heroku config:set ALLOWED_ORIGINS=https://cisco-firewall-selector.herokuapp.com
```

#### 5. Cr√©er un Procfile
```bash
echo "web: node server.js" > Procfile
```

#### 6. D√©ployer
```bash
git add .
git commit -m "Add PostgreSQL backend"
git push heroku main
```

#### 7. Initialiser la base de donn√©es
```bash
heroku run npm run init-db
```

#### 8. Ouvrir l'application
```bash
heroku open
```

### Sur un serveur VPS (Ubuntu):

#### 1. Installer Node.js et PostgreSQL
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs postgresql postgresql-contrib nginx
```

#### 2. Configurer PostgreSQL (voir section pr√©c√©dente)

#### 3. Cloner le projet
```bash
git clone https://github.com/votre-username/Cisco-Secure-Firewall-Selector.git
cd Cisco-Secure-Firewall-Selector
npm install
```

#### 4. Configurer `.env`
```bash
nano .env
# Ajoutez vos param√®tres
```

#### 5. Initialiser la base de donn√©es
```bash
npm run init-db
```

#### 6. Installer PM2 pour la gestion des processus
```bash
sudo npm install -g pm2
pm2 start server.js --name cisco-firewall
pm2 startup
pm2 save
```

#### 7. Configurer Nginx comme reverse proxy
```bash
sudo nano /etc/nginx/sites-available/cisco-firewall
```

Contenu:
```nginx
server {
    listen 80;
    server_name votre-domaine.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/cisco-firewall /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## üîç D√©pannage

### Probl√®me: "Connection refused" √† PostgreSQL

**Solution:**
1. V√©rifiez que PostgreSQL est d√©marr√©:
   ```bash
   sudo systemctl status postgresql
   ```
2. V√©rifiez les param√®tres de connexion dans `.env`
3. V√©rifiez que l'utilisateur a les permissions:
   ```sql
   GRANT ALL PRIVILEGES ON DATABASE cisco_firewalls TO cisco_user;
   ```

### Probl√®me: "CORS error" dans le navigateur

**Solution:**
Ajoutez votre domaine frontend √† `ALLOWED_ORIGINS` dans `.env`:
```env
ALLOWED_ORIGINS=http://localhost:3000,https://votre-domaine.com
```

### Probl√®me: Port 3000 d√©j√† utilis√©

**Solution:**
Changez le port dans `.env`:
```env
PORT=8080
```

---

## üìö Ressources suppl√©mentaires

- [Documentation PostgreSQL](https://www.postgresql.org/docs/)
- [Documentation Express.js](https://expressjs.com/)
- [Documentation node-postgres](https://node-postgres.com/)
- [Guide Heroku PostgreSQL](https://devcenter.heroku.com/articles/heroku-postgresql)

---

## üÜò Support

Si vous rencontrez des probl√®mes, v√©rifiez:
1. Les logs du serveur: `npm start` (regardez les messages d'erreur)
2. Les logs PostgreSQL: `sudo tail -f /var/log/postgresql/postgresql-15-main.log`
3. Testez la connexion √† la base: `psql -h localhost -U cisco_user -d cisco_firewalls`

---

## üìù Structure des fichiers

```
Cisco-Secure-Firewall-Selector/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ db.js                 # Configuration PostgreSQL
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ schema.sql            # Sch√©ma de la base de donn√©es
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ init-db.js            # Script d'initialisation
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ firewalls.json        # Donn√©es source
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ app.js                # Frontend JavaScript (modifi√© pour API)
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ styles.css
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ server.js                 # Serveur Express
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env.example              # Template de configuration
‚îú‚îÄ‚îÄ .env                      # Configuration (√† cr√©er)
‚îî‚îÄ‚îÄ DATABASE_SETUP.md         # Ce fichier
```

---

## ‚úÖ Checklist de d√©ploiement

- [ ] PostgreSQL install√© et d√©marr√©
- [ ] Base de donn√©es cr√©√©e
- [ ] Utilisateur PostgreSQL cr√©√© avec permissions
- [ ] `.env` configur√© avec les bonnes informations
- [ ] `.env` ajout√© √† `.gitignore`
- [ ] D√©pendances install√©es (`npm install`)
- [ ] Base de donn√©es initialis√©e (`npm run init-db`)
- [ ] Serveur d√©marre sans erreur (`npm start`)
- [ ] API accessible (`http://localhost:3000/api/health`)
- [ ] Frontend fonctionne et charge les donn√©es depuis l'API

---

**Bonne chance avec votre d√©ploiement! üöÄ**
